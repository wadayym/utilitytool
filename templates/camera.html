<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Pragma" content="no-store">
    <meta http-equiv="Cache-Control" content="no-store">
    <meta http-equiv="Expires" content="0">

    <title>カメラ表示</title>
</head>

<body>
	<video  id="player" width="1200" height="900" autoplay></video>
	<button id="capture">Capture</button>
	<canvas id="canvas" width="1200" height="900"></canvas>
	
	<script>
		var constraints = {
			audio: false,
			video: true,
		};

		var ua = navigator.userAgent;
		if(ua.indexOf("iPhone") > 0 || ua.indexOf("Android") > 0 && ua.indexOf("Mobile") > 0){
			constraints = {
				audio: false,
				video: {facingMode:'environment'},
			};
		}
		
		const video = document.getElementById('player');
		const canvas = document.getElementById('canvas');
		const context = canvas.getContext('2d');
		const captureButton = document.getElementById('capture');
		
		var form = document.createElement('form');
		var request = document.createElement('input');
	
		form.method = 'POST';
		form.action = '/camera';
	
		request.type = 'hidden'; //入力フォームが表示されないように
		request.name = 'image';
	
		captureButton.addEventListener('click', () => {
			// Draw the video frame to the canvas.
			context.drawImage(video, 0, 0, canvas.width, canvas.height);
			const base64_png = canvas.toDataURL("image/png");
			request.value = base64_png;
			form.appendChild(request);
			document.body.appendChild(form);
			form.submit();
		});

		const media = navigator.mediaDevices.getUserMedia(constraints);
		media.then(successCallback).catch(errorCallback);
		function successCallback(stream) {
			video.srcObject = stream;
		};
		function errorCallback(err) {
			alert(err);
		};
	</script>

</body>
</html>